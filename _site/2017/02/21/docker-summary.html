<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Docker 使用总结</title>
  <meta name="description" content="Docker 基本概念镜像 Image镜像是一些打包好的已有的环境，可以被用来启动和创建容器，本身不能被直接修改。容器 Container容器是镜像的实例化，是可以修改的，但是都是临时修改。容器启动过程  检查本地是否存在指定的镜像，不存在就从公有仓库下载  利用镜像创建并启动一个容器  分配一个文件系统，并在只...">

  <!-- CSS files -->
  <link rel="stylesheet" href="https://blog.mana.love/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://blog.mana.love/css/main.css">

  <link rel="canonical" href="https://blog.mana.love/2017/02/21/docker-summary.html">
  <link rel="alternate" type="application/rss+xml" title="喵喵清吟 | 爱菜家希望之神小飞鸟官方博客" href="https://blog.mana.love /feed.xml " />

  <!-- Icons -->
  <!-- 16x16 -->
  <!--<link rel="shortcut icon" href="https://blog.mana.love/favicon.ico">-->
   <!--32x32--> 
  <link rel="shortcut icon" href="https://blog.mana.love/img/favicon.png">
  <!--<link rel="shortcut icon" href="https://www.tuchuang001.com/images/2017/05/20/favicon.png">-->
    <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9e7b394e0b9f2ed7bbe4edf5607e7dad";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
         

<div class="cover-card table-cell table-middle">
  <!---->
  <a href="https://blog.mana.love/" class="avatar_a"><img src="" alt="" class="avatar" style="outline: 0;border: 0;"/></a>
  <!--<img src="https://www.tuchuang001.com/images/2017/05/20/site-avatar.png" alt="" class="avatar">-->
  <!---->
  <a href="https://blog.mana.love/" class="author_name">小飞鸟</a>
  <span class="author_job">爱菜家、希望之神</span>
  <span class="author_bio mbm">爱菜、爱菜、爱菜</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://blog.mana.love/">首页</a>
        <span>/</span>
      </li>
       
      <li class="nav-item">
        <a href="https://blog.mana.love/about/">关于</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="https://blog.mana.love/archive/">归档</a>
        
          <span>/</span>
        
      </li>
            
      <li class="nav-item">
        <a href="https://blog.mana.love/categories/">分类</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="https://blog.mana.love/links/">友链</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="https://blog.mana.love/tags/">标签</a>
        
          <span>/</span>
        
      </li>
                             
    </ul>
  </nav>
  <div class="social-links">
  <ul>
    <li><a href="http://github.com/ashidamana" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    <li><a href="http://www.weibo.com/flyerangel" class="social-link-item" target="_blank"><i class="fa fa-fw fa-weibo"></i></a></li>
    
    <li><a href="mailto:flyer@mana.love" class="social-link-item" target="_blank"><i class="fa fa-fw fa-envelope"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <!-- 判断是否插入首页图片 -->


<!-- 添加日期和阅读 -->
<div id="post">
    <header class="post-header">
        <span class="post-meta">
            <span class="post-date">
                2017-02-21
            </span> 
            •
            <span class="read-time" title="Estimated read time">
  
  
    3 mins read
  
</span>

            •
            阅读(<span data-hk-page="current"> - </span>次)<span class="pause"></span>
        </span>
        <h1 title="Docker 使用总结">Docker 使用总结</h1>
    </header>
    
    <!-- 引入google code pretiffy高亮样式 -->
    <link href="/js/google-code-prettify/themes/github-v2.css" rel="stylesheet" type="text/css" />
    
    <!-- 添加博文 -->
    <article class="post-content">
        <h2 id="docker-">Docker 基本概念</h2>

<h3 id="image">镜像 Image</h3>

<p>镜像是一些打包好的已有的环境，可以被用来启动和创建容器，本身不能被直接修改。</p>

<h3 id="container">容器 Container</h3>

<p>容器是镜像的实例化，是可以修改的，但是都是临时修改。</p>

<h3 id="section">容器启动过程</h3>

<ol>
  <li>检查本地是否存在指定的镜像，不存在就从公有仓库下载</li>
  <li>利用镜像创建并启动一个容器</li>
  <li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>
  <li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>
  <li>从地址池配置一个 ip 地址给容器</li>
  <li>执行用户指定的应用程序</li>
  <li>执行完毕后容器被终止</li>
</ol>

<h2 id="docker--1">Docker 常用命令</h2>

<h3 id="image-">Image 操作</h3>

<h4 id="section-1">基本操作</h4>

<ul>
  <li>显示本地所有镜像</li>
</ul>

<p><code>
docker images
</code></p>

<ul>
  <li>搜索一个image</li>
</ul>

<p><code>
docker search image_name
</code></p>

<ul>
  <li>下载image</li>
</ul>

<p><code>
docker pull image_name
</code></p>

<ul>
  <li>删除镜像</li>
</ul>

<p><code>
docker rmi image_name
</code></p>

<ul>
  <li>显示镜像历史</li>
</ul>

<p><code>
docker history image_name
</code></p>

<h4 id="section-2">制作镜像</h4>

<p><code>
docker build -t image_name DockerfilePath
</code></p>

<p>这里DockerfilePath是Context上下文目录，在创建的时候会全部上传到Docker Server端，所以这个目录不要太大</p>

<h4 id="section-3">迁移镜像</h4>

<ul>
  <li>保存镜像到文件</li>
</ul>

<p><code>
docker save image_name -o file.tar
</code></p>

<ul>
  <li>加载一个tar包的镜像</li>
</ul>

<p><code>
docker load -i file.tar
</code></p>

<h3 id="container-">Container 操作</h3>

<h4 id="section-4">显示相关</h4>

<ul>
  <li>查看运行中的容器</li>
</ul>

<p>```
docker ps</p>

<h1 id="section-5">一行显示全部容器</h1>
<p>docker ps | less -S</p>

<h1 id="section-6">最近一次启动</h1>
<p>docker ps -l</p>

<h1 id="section-7">列出所有容器</h1>
<p>docker ps -a
```</p>

<ul>
  <li>显示一个运行的容器里面的进程信息</li>
</ul>

<p><code>
docker top cid
</code></p>

<ul>
  <li>显示容器详细信息</li>
</ul>

<p><code>
docker inspect cid
</code></p>

<ul>
  <li>查看容器日志</li>
</ul>

<p>```
docker logs cid</p>

<h1 id="section-8">实时查看日志输出</h1>
<p>docker logs -f cid
```</p>

<ul>
  <li>查看容器更改</li>
</ul>

<p><code>
docker diff cid
</code></p>

<ul>
  <li>查看容器root用户密码</li>
</ul>

<p><code>
docker logs cid 2&gt;&amp;1 | grep '^User: ' | tail -n1
</code></p>

<h4 id="section-9">运行相关</h4>

<ul>
  <li>启动容器并执行一个命令（交互）</li>
</ul>

<p>```
# -t 终端
# -i 交互操作
docker run -it ubuntu /bin/bash</p>

<h1 id="hello-word">运行一个hello word然后就自动关闭</h1>
<p>docker run image_name echo “hello word”</p>

<h1 id="section-10">命名并启动容器</h1>
<p>docker run –name test ubuntu</p>

<h1 id="section-11">后台运行一个容器</h1>
<p>docker run -d -it ubuntu</p>

<h1 id="section-12">映射端口</h1>
<p>docker run -p 8080:8080 ubuntu</p>

<h1 id="volumn">挂载volumn</h1>
<p>docker run -v ./test:/var/www</p>

<h1 id="container--root-root">container 内 root 拥有真正root权限</h1>
<p>docker run –privileged=false</p>

<h1 id="section-13">启动完镜像后自动删除</h1>
<p>docker run -it –rm ubuntu bash
```</p>

<ul>
  <li>附着到正在运行的容器, 附着完以后退出会导致容器也终止</li>
</ul>

<p><code>
docker attach cid
</code></p>

<ul>
  <li>进入正在运行的 container 并且执行</li>
</ul>

<p><code>
docker exec -it 839a6cfc9496 /bin/bash
</code></p>

<ul>
  <li>在容器中运行一段程序</li>
</ul>

<p><code>
docker run ubuntu apt-get update
</code></p>

<ul>
  <li>拷贝文件出来</li>
</ul>

<p><code>
docker cp cid:/container_path to_path  
</code></p>

<h4 id="section-14">修改容器</h4>

<p>image相当于类，container相当于实例，不过可以动态给实例安装新软件，然后把这个container用commit命令固化成一个image</p>

<ul>
  <li>提交一个commit</li>
</ul>

<p><code>
docker commit cid new_image_name
</code></p>

<ul>
  <li>删除容器</li>
</ul>

<p>```
docker rm cid</p>

<h1 id="section-15">强制删除</h1>
<p>docker rm -f cid</p>

<h1 id="section-16">删除所有容器</h1>
<p>docker rm <code>docker ps -a -q</code>
```</p>

<ul>
  <li>状态修改</li>
</ul>

<p><code>
docker start/stop/kill/restart cid
</code></p>

<ul>
  <li>更改名字</li>
</ul>

<p><code>
docker rename old new
</code></p>

<h4 id="section-17">链接容器</h4>

<p>sonar容器连接到mysql容器，并将mysql容器重命名为db。这样，sonar容器就可以使用db的相关的环境变量了。</p>

<p><code>
docker run -it --name sonar -d -link mysql:db tpires/sonar-server
</code></p>

<h3 id="section-18">仓库操作</h3>

<ul>
  <li>登录到docker仓库</li>
</ul>

<p><code>
docker login
</code></p>

<ul>
  <li>上传镜像</li>
</ul>

<p><code>
docker push new_image_name
</code></p>

<h2 id="dockerfile-">Dockerfile 常用命令</h2>

<p>有了 Dockerfile 可以自定义一些自己需要的镜像，在熟悉了 Docker 基本操作，然后使用过一些别人提供好的镜像以后，难免需要自己修改一部分。</p>

<h3 id="from">FROM</h3>

<p>指定基础镜像。例如：</p>

<ul>
  <li>ubuntu</li>
  <li>nginx</li>
  <li>redis</li>
  <li>…</li>
</ul>

<p><code>
FROM nginx
</code></p>

<h3 id="run">RUN</h3>

<p>执行一些命令</p>

<p><code>
RUN echo '&lt;h1&gt;Hello, Docker!&lt;/h1&gt;' &gt; /usr/share/nginx/html/index.html
</code></p>

<p>每个RUN命令都会在容器中建立一层，所以尽量合并多个命令。例如</p>

<p><code>
RUN buildDeps='gcc libc6-dev make' \
    &amp;&amp; apt-get update \
    &amp;&amp; apt-get install -y $buildDeps \
    ...
</code></p>

<h3 id="copy">COPY</h3>

<p>复制文件到指定目录 source -&gt; target</p>

<p><code>
COPY ./package.json /usr/src/app
</code></p>

<h3 id="cmd">CMD</h3>

<p>容器的启动命令</p>

<p><code>
CMD ["nginx", "-g", "daemon off;"]
</code></p>

<p>这个命令可以在启动时被覆盖。另外它也可以为 ENTRYPOINT 提供参数。</p>

<blockquote>
  <p>CMD 理论上只能执行一次，如果想要执行两个命令，需要使用 <code>&amp;</code> 来连接两个命令，或者使用一个bash文件。更为高级一点的方法是用supervisor来管理</p>
</blockquote>

<h3 id="entrypoint">ENTRYPOINT</h3>

<p>ENTRYPOINT 和 CMD 有一部分重复工作，但是 ENTRYPOINT 可以让容器像软件一样执行。例如</p>

<p><code>
ENTRYPOINT /bin/echo
</code></p>

<p>在容器启动时，之后增加的内容都属于这个命令的参数。</p>

<h3 id="env">ENV</h3>

<p>设置环境变量。</p>

<p><code>ENV key value</code></p>

<h3 id="arg">ARG</h3>

<p>构建参数，在容器启动后不会存在。</p>

<h3 id="volume">VOLUME</h3>

<p>定义匿名卷，以免用户忘了挂载volumn，导致大量写入。这个 Volume 在容器启动前可以添加内容，但是并不是实际操作用户挂载的内容。在用户挂载完 volume 后，原来写在这里的内容会被复制到用户挂载的目录。</p>

<blockquote>
  <p>注意：在 VOLUME 命令之后对这个目录的所有操作，将被忽略。</p>
</blockquote>

<h3 id="expose">EXPOSE</h3>

<p>申明端口，可以用来默认映射端口，以及容器间互通。</p>

<p><code>
EXPOSE 22 80
</code></p>

<h3 id="workdir">WORKDIR</h3>

<p>指定工作目录。不仅是当前 docker 中的目录，同时也是运行容器时刚刚登录以后的目录。</p>

<h3 id="user">USER</h3>

<p>指定当前用户。</p>

<p><code>
RUN groupadd -r redis &amp;&amp; useradd -r -g redis redis
USER redis
RUN [ "redis-server" ]
</code></p>

<h3 id="healthcheck">HEALTHCHECK</h3>

<p>健康检查</p>

<h3 id="onbuild">ONBUILD</h3>

<p>当此容器作为别的容器的基础容器时操作内容</p>

<p><code>
FROM node:slim
RUN "mkdir /app"
WORKDIR /app
ONBUILD COPY ./package.json /app
ONBUILD RUN [ "npm", "install" ]
ONBUILD COPY . /app/
CMD [ "npm", "start" ]
</code></p>

<h2 id="docker-compose-">Docker-compose 常用指令</h2>

<h3 id="dependson">depends_on</h3>

<p>这个不仅可以保证build的先后顺序，还可以省去links的设置</p>

<h3 id="links">links</h3>

<p>和docker run命令一致，主要原因是在每次新开启container的时候，port可能会变，所以有了这个设置可以保证每次都可以绑定到正确的值。</p>

<h2 id="section-19">实例操作</h2>

<h3 id="lamp">创建一个LAMP的项目</h3>

<p>首先是目录结构</p>

<p><code>
├── README.md
├── apache
│   └── virtualhost.conf
├── docker-compose.yml
├── mysql
│   ├── Dockerfile
│   └── my.cnf
├── php
│   ├── Dockerfile
│   └── php.ini
└── src
    └── index.php
</code></p>

<p>创建 docker-compose.yml</p>

<p><code>yml
version: '2'
services:
  mysql:
    image: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: phpdata
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    volumes:
      - dbdata:/var/lib/mysql
  php:
    build: ./php
    ports:
      - '8080:80'
    volumes:
      - ./src:/var/www/html
      - ./apache:/etc/apache2/sites-enabled/
    depends_on:
      - mysql
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - '8081:80'
    links:
      - mysql:db
    environment:
      PMA_USER: root
      PMA_PASSWORD: password
    volumes:
      - adminsessions:/sessions
    depends_on:
      - mysql
      - php
volumes:
  dbdata:
  adminsessions:
</code></p>

<h2 id="section-20">问题记录</h2>

<h3 id="mysql--volume-">Mysql 挂载 volume 后启动时显示无权限</h3>

<p>设置mysql的启动模式 <code>privileged:true</code></p>

<p>另外这个问题一般不会发生，我之前遇到主要原因是我把多个 volume 都映射到了一个上面，导致目录内部读写发生冲突。</p>


        <!--百度分享-->
     <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more">分享到：</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友">QQ好友</a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧">百度贴吧</a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网">豆瓣网</a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a></div>
     <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16},"image":{"viewList":["tsina","sqq","qzone","tieba","weixin","douban","renren"],"viewText":"分享到：","viewSize":"24"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","sqq","qzone","tieba","weixin","douban","renren"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
        <!--网易云跟贴-->
        <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    </article>
</div>

<!-- 引入google code pretiffy -->
<script src="/js/jquery.min.js"></script>
<script src="/js/google-code-prettify/prettify.js"></script>
<script type="text/javascript">
    $(function(){
      $("pre").addClass("prettyprint linenums");
      prettyPrint();
      });
    </script>

<!-- 添加博文分割线 -->
<hr class="post-list__divider" />
<section>
       <ul class="pager">
        
        <li class="previous">
            <a href="/2017/02/19/setup-react-environment.html" data-toggle="tooltip" data-placement="top" title="React 学习 - 开发环境搭建">上一篇：  <span>React 学习 - 开发环境搭建</span>
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2017/05/19/japanese-preface.html" data-toggle="tooltip" data-placement="top" title="日语学习-前言">下一篇：  <span>日语学习-前言</span>
            </a>
        </li>
        
    </ul>
</section>


<!-- 多说评论框 start -->



        <footer>
  &copy; 2015-2017 喵喵清吟,blog.mana.love <br/>Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> Themes <a href="http://github.com/renyuanz/leonids/" target="_blank">Leonids</a>
</footer>




      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://blog.mana.love/js/jquery-2.1.4.min.js"></script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script type="text/javascript" src="https://blog.mana.love/js/main.js"></script>
<!--访问量统计工具 Hit Kounter v0.2-->
<script src="https://blog.mana.love/js/av-mini-0.6.10.js"></script>
<script src="https://blog.mana.love/js/hit-kounter-lc-0.2.0.js"></script>
<script type="text/javascript">
    var cloudTieConfig = {
        url: document.location.href,
        sourceId: "",
        productKey: "86a52c1e48c0450385a25e49e7c984cd",
        target: "cloud-tie-wrapper"
    };
    var yunManualLoad = true;
    Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>


</body>
</html>
